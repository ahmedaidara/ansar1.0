const { createClient } = require('@supabase/supabase-js');

const SUPABASE_URL = 'https://ncbfuuoupskhzgcjgpvq.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5jYmZ1dW91cHNraHpnY2pncHZxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI4NTMwNDYsImV4cCI6MjA2ODQyOTA0Nn0.3w7BT14mJeXQHBmZPNxbQwnArkk5wxytJ4aTqdYg4C8';

Deno.serve(async () => {
  const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
  const now = new Date().toISOString();
  const { data: autoMessages, error } = await supabase
    .from('auto_messages')
    .select('*')
    .lte('datetime', now);
  if (error) {
    console.error('Error fetching auto messages:', error);
    return new Response(JSON.stringify({ error: error.message }), { status: 500 });
  }
  for (const message of autoMessages) {
    await supabase.from('messages').insert([{
      title: message.name,
      text: message.text,
      date: now
    }]);
    await supabase.from('auto_messages').delete().eq('id', message.id);
  }
  return new Response(JSON.stringify({ success: true }), { status: 200 });
});
